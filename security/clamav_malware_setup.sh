#!/bin/bash

set -e

CLAM_LOG="/var/log/oneos-clamscan.log"
CLAM_QUARANTINE="/var/quarantine/clamav"
CLAM_CONFIG="/etc/clamav/oneos-clamav.conf"
SCAN_DIRS=("/root" "/home" "/tmp" "/var/tmp" "/usr/bin" "/usr/local/bin")
DB_UPDATE_LOG="/var/log/oneos-clamav-update.log"

install_clamav() {
    echo "[*] Installing ClamAV antivirus..."
    
    if ! command -v clamscan &> /dev/null; then
        apt-get update
        apt-get install -y clamav clamav-daemon clamav-freshclam
    fi
    
    mkdir -p "$CLAM_QUARANTINE"
    chmod 700 "$CLAM_QUARANTINE"
    
    echo "[✓] ClamAV installed"
}

update_virus_defs() {
    echo "[*] Updating virus definitions..."
    
    systemctl stop clamav-freshclam 2>/dev/null || true
    
    echo "[*] Fetching latest virus signatures..."
    freshclam --verbose >> "$DB_UPDATE_LOG" 2>&1 || true
    
    systemctl start clamav-freshclam 2>/dev/null || true
    
    echo "[✓] Virus definitions updated"
}

configure_clamav() {
    echo "[*] Configuring ClamAV for OneOS..."
    
    cat > "$CLAM_CONFIG" << 'CLAMAV_CONFIG'
LogFile /var/log/clamav/clamav.log
LogFileMaxSize 50M
LogClean yes
LogSyslog no

DatabaseDirectory /var/lib/clamav

MaxThreads 4
MaxEmbeddedPE 40M
MaxScanSize 200M
MaxFileSize 50M

Bytecode yes
BytecodeSecurity TrustSigned

Quarantine yes
QuarantineLocation /var/quarantine/clamav

HeuristicAlerts yes
HeuristicScanMode aggressive

CLAMAV_CONFIG
    
    echo "[✓] ClamAV configured"
}

create_daily_scan_cron() {
    echo "[*] Creating daily ClamAV scan job..."
    
    local cron_script="/usr/local/bin/oneos-clamscan-daily.sh"
    
    cat > "$cron_script" << 'SCAN_SCRIPT'
#!/bin/bash

SCAN_LOG="/var/log/oneos-clamscan.log"
QUARANTINE="/var/quarantine/clamav"
MAIL_LOG="/tmp/clamscan-report.txt"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting daily malware scan" >> "$SCAN_LOG"

> "$MAIL_LOG"

for dir in /root /home /tmp /var/tmp /usr/bin /usr/local/bin /opt; do
    if [ -d "$dir" ]; then
        echo "Scanning: $dir" >> "$MAIL_LOG"
        clamscan -r --quiet --move="$QUARANTINE" "$dir" >> "$MAIL_LOG" 2>&1
        RESULT=$?
        
        if [ $RESULT -eq 1 ]; then
            echo "⚠️  THREATS FOUND in $dir" >> "$MAIL_LOG"
        elif [ $RESULT -eq 0 ]; then
            echo "✓ Clean: $dir" >> "$MAIL_LOG"
        fi
    fi
done

echo "" >> "$MAIL_LOG"
echo "Scan completed at: $(date)" >> "$MAIL_LOG"

THREAT_COUNT=$(grep -i "infected" "$MAIL_LOG" | wc -l)
if [ "$THREAT_COUNT" -gt 0 ]; then
    echo "[!] SECURITY ALERT: Malware detected!" >> "$SCAN_LOG"
    
    if command -v mail &> /dev/null; then
        mail -s "OneOS: Malware Alert - $(date)" root < "$MAIL_LOG"
    fi
    
    notify-send -u critical "Security Alert" "Malware detected on system" 2>/dev/null || true
fi

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Daily scan complete - $THREAT_COUNT threats found" >> "$SCAN_LOG"
rm -f "$MAIL_LOG"
SCAN_SCRIPT
    
    chmod +x "$cron_script"
    
    (crontab -l 2>/dev/null | grep -v "clamscan-daily"; echo "0 2 * * * /usr/local/bin/oneos-clamscan-daily.sh") | crontab -
    
    echo "[✓] Daily scan scheduled"
}

enable_realtime_scanning() {
    echo "[*] Enabling real-time on-access scanning..."
    
    cat >> "/etc/clamav/clamd.conf" << 'CLAMD_CONFIG'

ScanOnAccess yes
OnAccessMountPath /home
OnAccessMountPath /tmp
OnAccessMountPath /var/tmp
OnAccessIncludePath /usr/bin
OnAccessIncludePath /usr/local/bin
OnAccessIncludePath /opt

OnAccessPrevention yes

CLAMD_CONFIG
    
    systemctl restart clamav-daemon 2>/dev/null || true
    
    echo "[✓] Real-time scanning enabled"
}

manage_quarantine() {
    echo "[*] Setting up quarantine management..."
    
    cat > "/usr/local/bin/oneos-quarantine-check.sh" << 'QUARANTINE_SCRIPT'
#!/bin/bash

QUARANTINE="/var/quarantine/clamav"
QUAR_LOG="/var/log/oneos-quarantine.log"

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Quarantine check" >> "$QUAR_LOG"

if [ -d "$QUARANTINE" ]; then
    FILE_COUNT=$(find "$QUARANTINE" -type f | wc -l)
    TOTAL_SIZE=$(du -sh "$QUARANTINE" | awk '{print $1}')
    
    echo "Quarantined files: $FILE_COUNT | Size: $TOTAL_SIZE" >> "$QUAR_LOG"
    
    echo "Recent quarantines:" >> "$QUAR_LOG"
    find "$QUARANTINE" -type f -printf "%TY-%Tm-%Td %TH:%TM - %p\n" | sort -r | head -10 >> "$QUAR_LOG"
    
    if [ "$FILE_COUNT" -gt 100 ]; then
        echo "[!] WARNING: Quarantine has $FILE_COUNT files" >> "$QUAR_LOG"
        notify-send -u critical "Quarantine Alert" "Many files quarantined ($FILE_COUNT)" 2>/dev/null || true
    fi
fi
QUARANTINE_SCRIPT
    
    chmod +x "/usr/local/bin/oneos-quarantine-check.sh"
    
    (crontab -l 2>/dev/null | grep -v "quarantine-check"; echo "0 * * * * /usr/local/bin/oneos-quarantine-check.sh") | crontab -
    
    echo "[✓] Quarantine management enabled"
}

add_custom_signatures() {
    echo "[*] Adding OneOS custom malware signatures..."
    
    local sig_dir="/var/lib/clamav"
    
    cat > "$sig_dir/oneos-custom.ndb" << 'SIGNATURES'
SIGNATURES
    
    echo "[✓] Custom signatures configured"
}

test_malware_detection() {
    echo "[*] Testing malware detection with EICAR test file..."
    
    local test_file="/tmp/eicar-test.com"
    
    echo "X5O!P%@AP[4\\PZX54(P^)7CC)7}\\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H+H*" > "$test_file"
    
    clamscan "$test_file"
    RESULT=$?
    
    if [ $RESULT -eq 1 ]; then
        echo "[✓] Malware detection working correctly"
    else
        echo "[!] Malware detection test failed"
    fi
    
    rm -f "$test_file"
}

generate_report() {
    echo ""
    echo "╔════════════════════════════════════════════════╗"
    echo "║     OneOS ClamAV Antivirus Configuration       ║"
    echo "╚════════════════════════════════════════════════╝"
    echo ""
    
    echo "Status:"
    systemctl is-active clamav-daemon >/dev/null && echo "  ✓ ClamAV daemon running" || echo "  ✗ ClamAV daemon stopped"
    systemctl is-active clamav-freshclam >/dev/null && echo "  ✓ Freshclam (DB updates) running" || echo "  ✗ Freshclam stopped"
    
    echo ""
    echo "Configuration:"
    echo "  Config file:      $CLAM_CONFIG"
    echo "  Quarantine dir:   $CLAM_QUARANTINE"
    echo "  Scan log:         $CLAM_LOG"
    echo "  Database updates: $DB_UPDATE_LOG"
    
    echo ""
    echo "Scanning:"
    echo "  • Daily scan at 2:00 AM"
    echo "  • Real-time on-access scanning enabled"
    echo "  • Hourly quarantine checks"
    
    echo ""
    echo "Database:"
    clamscan --version | head -1
    
    echo ""
    echo "Virus signatures:"
    if [ -d "/var/lib/clamav" ]; then
        find /var/lib/clamav -name "*.cvd" -o -name "*.cld" | wc -l
    fi
    
    echo ""
}

main() {
    echo ""
    echo "╔════════════════════════════════════════════════╗"
    echo "║   OneOS ClamAV Antivirus Setup                ║"
    echo "║   Daily scans + Real-time protection          ║"
    echo "╚════════════════════════════════════════════════╝"
    echo ""
    
    install_clamav
    update_virus_defs
    configure_clamav
    create_daily_scan_cron
    enable_realtime_scanning
    manage_quarantine
    add_custom_signatures
    test_malware_detection
    generate_report
    
    echo ""
    echo "[✓] ClamAV antivirus setup complete!"
    echo ""
}

main

